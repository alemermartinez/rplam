---
title: "README"
author: "Alejandra Martinez"
date: "`r format(Sys.Date(), '%d %B, %Y')`"
output:
  md_document:
    variant: markdown_github
---

Let first install package <code>rplam</code>.

```{r installation, results='hide', cache=FALSE, results=FALSE, warning=FALSE, comment=FALSE, message=FALSE}
library(devtools)
install_github("alemermartinez/rplam")
library(rplam)
```

The following is a real-data example of the implemention of the robust estimator based on B-splines under a partial linear additive model.

```{r loading data}

data(airquality)
x <- airquality
x <- x[ complete.cases(x), ]
x <- x[, c('Ozone', 'Solar.R', 'Wind', 'Temp','Month')]
y <- as.vector(x$Ozone)
X <- as.matrix(x[, c('Solar.R', 'Wind', 'Temp')])
Z <- as.matrix(x[, 'Month'])
```

As the \code{Z} is taken as a categorical variable, we convert it into a factor variable.
```{r Z factor}
Z <- as.factor(Z)
```


The degree selected for the spline basis is 3 for the three additive functions.
```{r spline degree}
degree.spline <- 3
```

The number of internal knots selected by the BIC criteria for the classical estimator is 9.
```{r number of knots classical}
nk.cl <- select.nknots.cl(y,Z,X,degree.spline=degree.spline)
nk.cl$nknots
```
And so is the number of internal knots selected using the RBIC criteria used for the robust proposal.
```{r number of knots robust}
nk.rob <- select.nknots.rob(y,Z,X,degree.spline=degree.spline)
nk.rob$nknots
```

Classical estimation of a partial linear additive model
```{r plam.cl}
fit.full.cl <- plam.cl(y,Z,X,degree.spline=degree.spline)
```
and the robust proposal
```{r plam.rob}
fit.rob <- plam.rob(y,Z,X,degree.spline=degree.spline)
```
When no number of internal knots is specified, select.knots.cl or select.knots.rob, respectively, is used.

The following three plots correspond to the classical (in red) and robust (in blue) fits for the additive functions with their respectively partial residuals.
```{r ggplot, echo=FALSE,warning=FALSE}
DF2 <- as.data.frame(list(
  rbind(X,X),
  c(fit.full.cl$y  - fit.full.cl$Z%*%fit.full.cl$coef.lin - fit.full.cl$alpha - rowSums(fit.full.cl$g.matrix[,-1]),fit.rob$y  - fit.rob$Z%*%fit.rob$coef.lin - fit.rob$alpha - rowSums(fit.rob$g.matrix[,-1])),
  c(fit.full.cl$y  - fit.full.cl$Z%*%fit.full.cl$coef.lin - fit.full.cl$alpha - rowSums(fit.full.cl$g.matrix[,-2]),fit.rob$y  - fit.rob$Z%*%fit.rob$coef.lin - fit.rob$alpha - rowSums(fit.rob$g.matrix[,-2])),
  c(fit.full.cl$y  - fit.full.cl$Z%*%fit.full.cl$coef.lin - fit.full.cl$alpha - rowSums(fit.full.cl$g.matrix[,-3]),fit.rob$y  - fit.rob$Z%*%fit.rob$coef.lin - fit.rob$alpha - rowSums(fit.rob$g.matrix[,-3])),
  rbind(fit.full.cl$g.matrix,fit.rob$g.matrix),
  c(rep("Classical",111),rep("Robust",111))
))
names(DF2) <- c("x1","x2","x3","re.1", "re.2", "re.3", "g1","g2","g3","Fit")

library(ggplot2)
ggplot(DF2,aes(x=x1,y=re.1,color=Fit)) +
  geom_point(alpha=0.5)+
  geom_line(aes(x=x1,y=g1),size=1.3,alpha=1)+
  scale_color_manual(values = c("#bb0c00","#0052bb"))+
  theme(
    axis.title.y=element_blank()
  )


ggplot(DF2,aes(x=x2,y=re.2,color=Fit)) +
  geom_point(alpha=0.5)+
  geom_line(aes(x=x2,y=g2),size=1.3,alpha=1)+
  scale_color_manual(values = c("#bb0c00","#0052bb"))+
  theme(
    axis.title.y=element_blank()
  )


ggplot(DF2,aes(x=x3,y=re.3,color=Fit)) +
  geom_point(alpha=0.5)+
  geom_line(aes(x=x3,y=g3),size=1.3,alpha=1)+
  scale_color_manual(values = c("#bb0c00","#0052bb"))+
  theme(
    axis.title.y=element_blank()
  )

```

Since fits are not quite similar, we are going to study the residuals obtained by the robust estimator.
```{r residuals}
res.rob <- y-fit.rob$prediction
summary(res.rob)
```

```{r residuals plots, echo=FALSE,warning=FALSE}
DF3 <- as.data.frame(list(
  1:111,
  y-fit.rob$prediction
))
names(DF3) <- c("Position","Residuals")

library(cowplot)
p1 <- ggplot(DF3,aes(y=Residuals))+
  geom_boxplot(fill='#0052bb',alpha=0.5)+
  theme(
    axis.text.x=element_blank()
  )

p2 <- ggplot(DF3,aes(x=Position,y=Residuals))+
  geom_point(alpha=0.5,color="#0052bb")+
  geom_abline(intercept = 0,slope=0)+
  theme(
    axis.title.x=element_blank(),
    axis.title.y=element_blank(),
    axis.text.x=element_blank()
  )

p3 <- ggplot(DF3,aes(sample=Residuals))+
  geom_qq()+stat_qq_line()+
  theme(
    axis.title.x=element_blank(),
    axis.title.y=element_blank(),
    axis.text.x=element_blank()
  )

plot_grid(p1, p2, p3)
```
